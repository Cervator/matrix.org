name: Update public instances
on:
  pull_request:
    branches:
      - main

jobs:
  run:
    name: Update public instances
    runs-on: ubuntu-latest
    steps:
      - name: Checkout matrix.org source
        uses: actions/checkout@v4
        with:
          path: 'morg'

      - name: Checkout the public instance updater
        uses: actions/checkout@v4
        with:
          repository: 'thibaultamartin/public-instances-updater'
          path: 'piu'

      - name: Update public instance data on the runner
        run: |
          cp morg/content/public-instances/instances.toml piu/instances.toml
          cd piu && yarn && yarn run update && cd ..
          cp piu/instances.toml morg/content/public-instances/instances.toml

      - name: Commit and push data (within PR)
        if: github.event_name == 'pull_request'
        run: |
          git config --global user.name "GitHub CI"
          git config --global user.email "noreply@matrix.org"
          git switch $GITHUB_REF_NAME
          git add public-instances/instances.toml
          git commit -m "Update instances.toml"
          git push
        working-directory: morg

      - name: Commit and push data (scheduled)
        if: ${{ github.event_name == 'schedule' }}
        run: |
          git config --global user.name "GitHub CI"
          git config --global user.email "noreply@matrix.org"
          git add public-instances/instances.toml
          git commit -m "Update instances.toml"
          git push
        working-directory: morg
